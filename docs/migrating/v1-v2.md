# Migrating from v1 to V2

Carbon v2 has changed the test runner from Karma to [Jest](https://facebook.github.io/jest/).

## Carbon Factory Test Setup Changes

### Basic Setup Changes

You need to create a `.babelrc` file in the root of your application (alongside your `gulpfile.js`), this should contain the following:

```
{
  "extends": "./node_modules/carbon-factory/.babelrc"
}
```

For the simplest of setups there should be no additional changes required when migration from v1 and v2. `gulp test` and `gulp test --build` should mostly work the same as before and will automatically include coverage reports. However there are some important steps to note:

* It is recommended that you [setup the JestCLI](#setting-up-the-jestcli).
* For builds using custom configuration options see [Advanced Configuration](#advanced-configuration).
* For build using spec helpers see the [Spec Helpers](#spec-helpers) upgrade guide.
* Some specs may need to be rewritten to pass successfully, see the [Spec Updates](#spec-updates) guide.

### Advanced Setup Changes

#### Setting up the JestCLI

While `gulp test` will give you the basic command for running Jest, the JestCLI instead [supports many additional options](https://facebook.github.io/jest/docs/cli.html). Therefore it is useful to set this up in your application.

You need to create a `jest.conf.json` file in the root of your application (where we added the `.babelrc` earlier), and insert the following:

```
{
  "preset": "./node_modules/carbon-factory/jest.conf.json"
}
```

This ensures that you inherit the base configuration we supply from Carbon Factory.

Secondly, you need to update or add the `test` script to your main `package.json`:

```
"scripts": {
  "test": "jest --config=./jest.conf.json"
}
```

You should now be able to run `npm test` in your terminal to execute the JestCLI. You can pass additional options to the command by inserting a `--` between `npm test` and the Jest arguments. For example:

```
npm test -- --watch --onlyChanged
```

For more details on running tests see the [Running Specs Document](https://github.com/Sage/carbon-factory/blob/master/docs/running-tests.md)

#### Advanced Configuration

For more complicated setups where you are defining your own coverage limit, spec helpers or additional modules to run babel on you will need to provide extra configuration via your `jest.conf.json` file (if you have not already, please complete the 'Setting up the JestCLI' task above).

Firstly you need to ensure that gulp is using the same custom configuration as the JestCLI. For this you need to update your `gulpfile.js` task to require the custom config:

```js
gulp.task('test', SpecTask({
  jestConfig: require('./jest.conf.json')
}));
```

You can now add additional config to your config file. You can see what configuration can be set from the [official Jest documentation](https://facebook.github.io/jest/docs/configuration.html). An example of using the preset from Carbon Factory, but overriding some options may look like this:

```js
{
  "preset": "./node_modules/carbon-factory/jest.conf.json",
  "coverageThreshold": {
    "global": {
      "branches": 90,
      "functions": 90,
      "lines": 90,
      "statements": 90
    }
  }
}
```

#### Spec Helpers

v1 of Carbon Factory allowed you to define spec helpers that would run before any of the tests. In Jest these helpers need to be included using the `setupFiles` option in your Jest config. To add a basic spec helper file add the following to your `jest.conf.json` file.

```js
"setupFiles": [
  "./src/__spec_helper__/index.js"
],
```

You can provide an array of multiple files here, but it is probably easier to maintain a single file which imports all of the other spec helpers.

## Spec Updates

Jest is forked from Jasmine and therefore follows a lot of the same syntax, style and conventions. This means that migrating from jasmine should be easy. However as a fork, Jest, has removed some of Jasmines features in favor of their own implementations. We have compiled a small list of common changes you may be required to make to convert your tests from Jasmine to Jest.

### Mock Functions

`spyOn` is still supported in Jest, however there is a different way to create new mock objects which is useful to know about. Creating mock functions in Jest can be done using `jest.fn();`

```js
const myMock = jest.fn();
```

The mock object has a mock property attached to it, which lets you track calls, arguments, etc.:

```js
expect(myMock.mock.calls.length).toBe(1);
expect(myMock.mock.calls[0][0]).toBe(‘foo’);
```

You can setup return values using mockReturnValue, and mockReturnValueOnce:

```js
myMock.mockReturnValueOnce(‘moo’)
  .mockReturnValueOnce(‘oink’)
  .mockReturnValue(‘neigh’);
// myMock returns ‘moo’, ‘oink’, then ‘neigh’ for each subsequent call
```

Also, if your mock needs to support method chaining you can use mockReturnThis:

```js
myMock.mockReturnThis();
```

You can find more information on the [official Jest Documentation](https://facebook.github.io/jest/docs/mock-function-api.html).

### Timer Mocks

Where previously you used `jasmine.clock()` to mock `setTimeout` and `setInterval`, in Jest you need to use `jest.useFakeTimers()`. To uninstall the i fake timers you can use `jest.useRealTimers()`.

In your tests, you can control the timers via three methods:

```js
// Runs all timers until they have all been executed
jest.runAllTimers();
// Run only the pending timers
jest.runOnlyPendingTimers();
// Run timers until the elapsed ms
jest.runTimersToTime(1000);
// Clear all outstanding timers
jest.clearAllTimers();
```

You can find more information on the [official Jest Documentation](https://facebook.github.io/jest/docs/jest-object.html).

### Mocking the Date

Jasmine lets you mock specific dates using `jasmine.clock().mockDate()`. Jest doesn’t appear to have any direct replacement for this itself, so we’re using the `MockDate` package as a replacement. You use it like so:

```js
// Import the package
import MockDate from 'mockdate';

// Setup the mock behaviour
const baseTime = new Date('2/2/2000');
MockDate.set(baseTime);
// new Date().toString() => "Wed Feb 02 2000 00:00:00"

// Reset the mock date
MockDate.reset()
```

### Ajax Testing

Now we're using Jest, you can no longer use Jasmine Ajax in your specs. Instead you'll need to mock the appropriate modules and/or functions as required.

For example, if you need to test code that uses `superagent` for Ajax requests, you'll find a handy mock implementation of `superagent` in the `__mocks__` folder. To use this in your specs:

Import `superagent` into your spec:

```js
import Request from 'superagent';
```

Tell Jest to mock superagent:

```js
jest.mock('superagent');
```

You can then mock the `Request` methods you need to and check it was called with the correct arguments:

```js
it('queries for data with the correct page and rows', () => {
  Request.query = jest.fn().mockReturnThis();
  ...
  expect(Request.query).toBeCalledWith('page=1&rows=10');
});
```

Or override the mock response:

```js
Request.__setMockResponse({
  status() {
    return 200;
  },
  ok() {
    return true;
  },
  body: {
    data: ['foo']
  }
});
```

Or the mock error:

```js
Request.__setMockError({
  message: 'Unsuccessful HTTP response'
});
```

Or the mock delay if required:

```js
Request.__setMockDelay(true);
```
